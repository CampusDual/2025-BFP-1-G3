<div class="container">
  <div class="candidate-profile-container">
    <div class="candidate-header-card">
      <div class="avatar-section">
        <app-editable-avatar 
          [candidateId]="candidateData?.id ?? null" 
          [profilePhotoUrl]="candidateData?.profilePhotoUrl"
          size="large"
          (photoChanged)="onPhotoChanged($event)">
        </app-editable-avatar>
        <div class="candidate-info">
          <h2>{{ userData?.candidate?.name }} {{ userData?.candidate?.surname1 }} {{ userData?.candidate?.surname2 }}
          </h2>
          <p class="candidate-email"><mat-icon>email</mat-icon> {{ userData?.candidate?.email }}</p>
          <p class="candidate-extra" *ngIf="userData?.candidate?.phone">
            <mat-icon>phone</mat-icon> {{ userData?.candidate?.phone }}
          </p>
          <a id="linkedin-container" *ngIf="userData?.candidate?.linkedin" [href]="userData?.candidate?.linkedin" target="_blank"
            class="linkedin-icon" matTooltip="Ver perfil de LinkedIn">
            <i class="fa-brands fa-linkedin"></i> <span id="linkedin-link">{{userData?.candidate?.linkedin}}</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <mat-tab-group (selectedTabChange)="onTabChanged($event)" [selectedIndex]="selectedTabIndex">
    <!-- Pestaña de Datos del Usuario -->
    <mat-tab label="Mis Datos">
      <div class="tab-content">
        <!-- Botones de acción -->
        <div class="profile-actions" *ngIf="!isEditing">
          <button mat-raised-button color="primary" (click)="startEditing()">
            <mat-icon>edit</mat-icon>
            Editar Perfil
          </button>
        </div>

        <div class="edit-actions" *ngIf="isEditing">
          <button mat-button (click)="cancelEditing()" [disabled]="isSubmitting">
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>
          <button mat-raised-button color="primary" (click)="saveChanges()" [disabled]="isSubmitting">
            <mat-spinner diameter="20" *ngIf="isSubmitting" style="margin-right: 8px;"></mat-spinner>
            <mat-icon *ngIf="!isSubmitting">save</mat-icon>
            <span *ngIf="!isSubmitting" style="margin-left: 4px;">Guardar Cambios</span>
            <span *ngIf="isSubmitting">Guardando...</span>
          </button>
        </div>

        <!-- Vista en modo lectura -->
        <div *ngIf="!isEditing" class="profile-view">
          <div class="profile-section">
            <h3>Información Personal</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Nombre completo:</span>
                <span class="info-value">{{ profileForm.get('name')?.value }} {{ profileForm.get('surname1')?.value }} {{ profileForm.get('surname2')?.value }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Email:</span>
                <span class="info-value">{{ profileForm.get('email')?.value }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Teléfono:</span>
                <span class="info-value">{{ profileForm.get('phone')?.value }}</span>
              </div>
              <div class="info-item" *ngIf="profileForm.get('linkedin')?.value">
                <span class="info-label">LinkedIn:</span>
                <span class="info-value">
                  <a [href]="profileForm.get('linkedin')?.value" target="_blank" class="linkedin-link">
                    {{ profileForm.get('linkedin')?.value }}
                  </a>
                </span>
              </div>
            </div>
          </div>

          <div class="profile-section">
            <h3>Perfil Profesional</h3>
            <div class="info-grid">
              <div class="info-item" *ngIf="professionalForm.get('professionalTitle')?.value">
                <span class="info-label">Título Profesional:</span>
                <span class="info-value">{{ professionalForm.get('professionalTitle')?.value }}</span>
              </div>
              <div class="info-item" *ngIf="professionalForm.get('yearsExperience')?.value">
                <span class="info-label">Años de Experiencia:</span>
                <span class="info-value">{{ professionalForm.get('yearsExperience')?.value }} años</span>
              </div>
              <div class="info-item" *ngIf="professionalForm.get('employmentStatus')?.value">
                <span class="info-label">Situación Laboral:</span>
                <span class="info-value">{{ getEmploymentStatusText(professionalForm.get('employmentStatus')?.value) }}</span>
              </div>
              <div class="info-item" *ngIf="professionalForm.get('availability')?.value">
                <span class="info-label">Disponibilidad:</span>
                <span class="info-value">{{ getAvailabilityText(professionalForm.get('availability')?.value) }}</span>
              </div>
              <div class="info-item" *ngIf="professionalForm.get('preferredModality')?.value">
                <span class="info-label">Modalidad Preferida:</span>
                <span class="info-value">{{ getModalityText(professionalForm.get('preferredModality')?.value) }}</span>
              </div>
              <div class="info-item" *ngIf="professionalForm.get('githubProfile')?.value">
                <span class="info-label">Perfil GitHub:</span>
                <span class="info-value">
                  <a [href]="professionalForm.get('githubProfile')?.value" target="_blank" class="github-link">
                    {{ professionalForm.get('githubProfile')?.value }}
                  </a>
                </span>
              </div>
              <div class="info-item" *ngIf="professionalForm.get('presentation')?.value">
                <span class="info-label">Presentación Personal:</span>
                <span class="info-value presentation-text">{{ professionalForm.get('presentation')?.value }}</span>
              </div>
              <div class="info-item" *ngIf="selectedTechLabels.length > 0">
                <span class="info-label">Tecnologías:</span>
                <div class="tech-labels-display">
                  <span *ngFor="let label of selectedTechLabels" class="tech-chip-display">
                    {{ label.name }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vista en modo edición -->
        <div *ngIf="isEditing">
          <form [formGroup]="profileForm">
            <div class="form-section">
              <h3>Información Personal</h3>
              <div class="form-grid">
                <mat-form-field appearance="outline">
                  <mat-label>Nombre</mat-label>
                  <input matInput formControlName="name" required>
                  <mat-error *ngIf="profileForm.get('name')?.hasError('required')">
                    El nombre es requerido
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Primer Apellido</mat-label>
                  <input matInput formControlName="surname1" required>
                  <mat-error *ngIf="profileForm.get('surname1')?.hasError('required')">
                    El primer apellido es requerido
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Segundo Apellido</mat-label>
                  <input matInput formControlName="surname2" required>
                  <mat-error *ngIf="profileForm.get('surname2')?.hasError('required')">
                    El segundo apellido es requerido
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Teléfono</mat-label>
                  <input matInput formControlName="phone" required>
                  <mat-error *ngIf="profileForm.get('phone')?.hasError('required')">
                    El teléfono es requerido
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Email</mat-label>
                  <input matInput formControlName="email" type="email" required>
                  <mat-error *ngIf="profileForm.get('email')?.hasError('required')">
                    El email es requerido
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>LinkedIn (opcional)</mat-label>
                  <input matInput formControlName="linkedin">
                </mat-form-field>
              </div>
            </div>
          </form>

          <form [formGroup]="professionalForm">
            <div class="form-section">
              <h3>Perfil Profesional</h3>
              <div class="form-grid">
                <mat-form-field appearance="outline">
                  <mat-label>Título Profesional</mat-label>
                  <input matInput formControlName="professionalTitle" placeholder="ej. Desarrollador Full Stack">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Años de Experiencia</mat-label>
                  <input matInput type="number" formControlName="yearsExperience" min="0" max="50">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Situación Laboral</mat-label>
                  <mat-select formControlName="employmentStatus">
                    <mat-option value="EMPLOYED">Empleado</mat-option>
                    <mat-option value="UNEMPLOYED">Desempleado</mat-option>
                    <mat-option value="STUDENT">Estudiante</mat-option>
                    <mat-option value="FREELANCER">Freelancer</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Disponibilidad</mat-label>
                  <mat-select formControlName="availability">
                    <mat-option value="IMMEDIATE">Inmediata</mat-option>
                    <mat-option value="TWO_WEEKS">2 semanas</mat-option>
                    <mat-option value="ONE_MONTH">1 mes</mat-option>
                    <mat-option value="THREE_MONTHS">3 meses</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Modalidad Preferida</mat-label>
                  <mat-select formControlName="preferredModality">
                    <mat-option value="REMOTE">Remoto</mat-option>
                    <mat-option value="ONSITE">Presencial</mat-option>
                    <mat-option value="HYBRID">Híbrido</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Perfil GitHub (opcional)</mat-label>
                  <input matInput formControlName="githubProfile" placeholder="https://github.com/usuario">
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width-field">
                  <mat-label>Presentación Personal</mat-label>
                  <textarea matInput formControlName="presentation" rows="4" 
                    placeholder="Cuéntanos un poco sobre ti, tus objetivos profesionales y lo que te motiva..."></textarea>
                </mat-form-field>
              </div>

              <!-- Sección de Tecnologías -->
              <div class="tech-labels-section">
                <h3>Áreas de Especialización</h3>
                <p class="helper-text">Selecciona hasta 10 tecnologías en las que tienes experiencia</p>
                
                <div *ngIf="loadingTechLabels" class="loading-message">
                  <mat-spinner diameter="30"></mat-spinner>
                  <span>Cargando tecnologías...</span>
                </div>

                <div *ngIf="!loadingTechLabels && availableTechLabels.length > 0" class="tech-labels-grid">
                  <mat-checkbox *ngFor="let label of availableTechLabels" 
                    [checked]="isTechLabelSelected(label.id)"
                    [disabled]="!canSelectMoreTechLabels(label.id)"
                    (change)="onTechLabelChange($event, label)">
                    {{ label.name }}
                  </mat-checkbox>
                </div>

                <div class="selected-count">
                  Seleccionadas: {{ selectedTechLabels.length }}/10
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </mat-tab>

    <!-- Pestaña de Mis Candidaturas -->
    <mat-tab label="Mis Candidaturas">
      <div class="tab-content">
        <div class="applications-header">
          <h3>Ofertas en las que estás inscrito</h3>
          <button mat-raised-button color="primary" (click)="loadMyApplications()" [disabled]="loadingApplications">
            <mat-icon>refresh</mat-icon>
            Actualizar
          </button>
        </div>

        <div *ngIf="loadingApplications" class="loading-message">
          <mat-spinner diameter="30"></mat-spinner>
          <p>Cargando candidaturas...</p>
        </div>

        <div *ngIf="applicationsError" class="error-message">
          {{ applicationsError }}
        </div>

        <div *ngIf="!loadingApplications && myApplications.length === 0 && !applicationsError" class="no-applications">
          <mat-icon>info</mat-icon>
          <p>Todavía no te has inscrito en ninguna oferta</p>
        </div>

        <div *ngIf="!loadingApplications && myApplications.length > 0" class="applications-list">
          <mat-card *ngFor="let application of myApplications" class="application-card">
            <mat-card-header>
              <mat-card-title>{{ application.offer.title || 'Sin título' }}</mat-card-title>
              <mat-card-subtitle>{{ application.offer.company?.name || application.offer.companyName || 'Sin empresa'
                }}</mat-card-subtitle>
              <div class="state-badge" [ngClass]="getStateClass(application.state)">
                {{ getStateText(application.state) }}
              </div>
            </mat-card-header>

            <mat-card-content>
              <p class="offer-description">{{ application.offer.description || application.offer.offerDescription ||
                'Sin descripción' }}</p>
              <div class="offer-details">
                <div class="detail-item" *ngIf="application.offer.location">
                  <mat-icon>location_on</mat-icon>
                  <span>{{ application.offer.location }}</span>
                </div>
                <div class="detail-item" *ngIf="application.offer.startDate && application.offer.endDate">
                  <mat-icon>date_range</mat-icon>
                  <span>{{ application.offer.startDate | date:'dd/MM/yyyy' }} - {{ application.offer.endDate |
                    date:'dd/MM/yyyy' }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>